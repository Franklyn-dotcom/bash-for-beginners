#!/bin/bash

# A script that allows users to quickly upload files
# to a specified cloud storage solution, providing a simple and seamless 
# upload experience similar to popular storage services.


setup() { 
    # Install civo cli
    curl -sL https://civo.com/get | sudo bash

    # Add civo api key for authentication

    civo apikey add Demo_Test dk0xRbKM5P3LPvYPlwscFOux8FoLl9pZ7AWR9b0V25PRieHv9W
    echo "Api key added successfully."
    echo -e "\n\n"
}

# create and list the object credential store in your account 

create_obj_cred(){

    #create the obj store credential

    civo objectstore credential create project-cred --region FRA1

    #echo "Credential created successfully"

    # list the obj store credential
    civo objectstore credential ls --region FRA1
 
    echo -e "\n"
}

create_obj_store(){

    #create object store 
    civo objectstore create project-obj-store --name project-cred --region FRA1

    # list object store bucket

    civo objectstore ls

}

upload_files_store(){
    #install s3cmd
    #sudo pip install s3cmd

    # create a for loop to enable user to upload selected file or all the files
    declare -a arr=($@)
    for i in ${arr[@]}
    do

    #check if it is a file
    if [[ -f "$i" ]];
    then

        file_exists=$(civo objectstore ls s3://project-obj-store | grep "$i")
        if [[ -n $file_exists  ]];
        then

            read -p "File '${file_name}' already exists. What would you like to do? (o)verwrite, (s)kip " choice
            case $choice in
            o | O)
                 pv "$i" | s3cmd --host=objectstore.fra1.civo.com  --host-bucket=s3://project-obj-store put --acl-public "$i" s3://project-obj-store
                 echo "$i file  overwritten successfully"
                 ;;
            s | S)
                 echo "Skipping $i"
                 ;;
            esac

        else
            while true;
            do
              read -p "Do you want to upload $i file: y | n " upload_file
              if [[ $upload_file =~ [yY] ]];
              then
                  openssl enc -aes-256-cbc -salt -in "$i" -out "$i.enc"
                  pv "$i" | s3cmd --host=objectstore.fra1.civo.com  --host-bucket=s3://project-obj-store put --acl-public "$i.enc" s3://project-obj-store
                  echo "Successfully uploaded $i"
                  break 1

              elif [[ $upload_file =~ [nN] ]];
              then
                  echo "Okay. Skipping $i"
                  break

              else
                  echo "You didn't select any choice. 0 file Uploaded." 

              fi
            done
       fi
    else
        echo "No file found. It might be a directory"

    fi
    done
}



file_nae=("create_resource_group" "create_storage_instance" "hello-dummy.txt")


setup
create_obj_cred
create_obj_store
upload_files_store ${file_nae[@]}
